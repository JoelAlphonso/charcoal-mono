/*! charcoal-admin 12-08-2015 */
var Charcoal=Charcoal||{};Charcoal.Admin=function(){"use strict";function a(){}var b,c={base_url:null,admin_path:null};return a.set_data=function(a){c=$.extend(!0,c,a)},a.admin_url=function(){return c.base_url+c.admin_path+"/"},a.manager=function(){return"undefined"==typeof b&&(b=new Charcoal.Admin.ComponentManager),b},a.get_object_name=function(a){var b=a.split("/");return b=b.splice(2,b.length),b.forEach(function(a,b,c){c[b]=a.charAt(0).toUpperCase()+a.slice(1)}),a=b.join("_")},a}(),Charcoal.Admin.ComponentManager=function(){var a=this;a.components={},$(document).on("ready",function(){a.render()})},Charcoal.Admin.ComponentManager.prototype.add_property_input=function(a){this.add_component("property_inputs",a)},Charcoal.Admin.ComponentManager.prototype.add_widget=function(a){this.add_component("widgets",a)},Charcoal.Admin.ComponentManager.prototype.add_template=function(a){this.add_component("templates",a)},Charcoal.Admin.ComponentManager.prototype.add_component=function(a,b){var c=Charcoal.Admin.get_object_name(b.type);"function"==typeof Charcoal.Admin[c]?(b.ident=c,this.components[a]=this.components[a]||[],this.components[a].push(b)):console.log("Was not able to store "+c+" in "+a+" sub-array")},Charcoal.Admin.ComponentManager.prototype.render=function(){for(var a in this.components)for(var b=0,c=this.components[a].length;c>b;b++){var d=this.components[a][b];try{var e=new Charcoal.Admin[d.ident](d);this.components[a][b]=e}catch(f){console.log("Was not able to instanciate "+d.ident)}}},Charcoal.Admin.Property=function(a){window.alert("Property "+a)},Charcoal.Admin.Property_Audio=function(a){this.property_type="charcoal/admin/property/audio",this.audio_context=null,this.audio_recorder=null,this.animation_frame=null,this.analyser_context=null,this.canvas_width=0,this.canvas_height=0,this.recording_index=0,this.current_recording=null,this.audio_player=null,this.$record_button=$(".btn-record:first"),this.$stop_record_button=$(".btn-stop-record:first"),this.$playback_button=$(".btn-play:first"),this.$reset_button=$(".btn-reset:first"),this.init(a)},Charcoal.Admin.Property_Audio.prototype=Object.create(Charcoal.Admin.Property.prototype),Charcoal.Admin.Property_Audio.prototype.constructor=Charcoal.Admin.Property_Audio,Charcoal.Admin.Property_Audio.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Audio.prototype.default_data=function(){return{obj_type:"",input_id:null}},Charcoal.Admin.Property_Audio.prototype.set_data=function(a){return this.obj_type=a.obj_type,this.input_id=a.input_id,this},Charcoal.Admin.Property_Audio.prototype.init=function(a){var b=$.extend(!0,{},this.default_data(),a);this.set_data(b),this.init_audio()},Charcoal.Admin.Property_Audio.prototype.init_audio=function(){var a=this;window.navigator.getUserMedia||(window.navigator.getUserMedia=window.navigator.webkitGetUserMedia||window.navigator.mozGetUserMedia),window.navigator.cancelAnimationFrame||(window.navigator.cancelAnimationFrame=window.navigator.webkitCancelAnimationFrame||window.navigator.mozCancelAnimationFrame),window.navigator.requestAnimationFrame||(window.navigator.requestAnimationFrame=window.navigator.webkitRequestAnimationFrame||window.navigator.mozRequestAnimationFrame),window.AudioContext||(window.AudioContext=window.AudioContext||window.webkitAudioContext),window.navigator.getUserMedia({audio:{mandatory:{googEchoCancellation:!1,googAutoGainControl:!1,googNoiseSuppression:!1,googHighpassFilter:!1},optional:[]}},function(b){a.bind_events(),a.got_stream(b)},function(a){window.alert("Error getting audio. Try plugging in a microphone"),window.console.log(a)})},Charcoal.Admin.Property_Audio.prototype.bind_events=function(){var a=this;a.$record_button.on("click",function(){a.manage_recording()}),a.$stop_record_button.on("click",function(){a.manage_recording("stop")}),a.$playback_button.on("click",function(){0!==a.recording_index&&null!==a.audio_player&&a.toggle_playback()}),a.$reset_button.on("click",function(){a.reset_audio()})},Charcoal.Admin.Property_Audio.prototype.got_stream=function(a){var b=this;b.audio_context=new window.AudioContext,b.audio_player=new window.Audio_Player({on_ended:function(){b.manage_button_states("pause_playback")}});var c=b.audio_context.createGain(),d=b.audio_context.createMediaStreamSource(a),e=null;d.connect(c),window.analyserNode=b.audio_context.createAnalyser(),window.analyserNode.fftSize=2048,c.connect(window.analyserNode),b.audio_recorder=new window.Recorder(c),e=b.audio_context.createGain(),e.gain.value=0,c.connect(e),e.connect(b.audio_context.destination),b.update_analysers()},Charcoal.Admin.Property_Audio.prototype.manage_button_states=function(a){switch(a){case"start_recording":this.$record_button.text(this.$record_button.attr("data-label-pause")),this.$record_button.addClass("-is-recording"),this.$stop_record_button.prop("disabled",!1),this.$playback_button.prop("disabled",!0),this.$reset_button.prop("disabled",!1);break;case"pause_recording":this.$record_button.text(this.$record_button.attr("data-label-record")),this.$record_button.removeClass("-is-recording"),this.$stop_record_button.prop("disabled",!1),this.$playback_button.prop("disabled",!0),this.$reset_button.prop("disabled",!1);break;case"stop_recording":this.$record_button.text(this.$record_button.attr("data-label-record")),this.$record_button.removeClass("-is-recording"),this.$stop_record_button.prop("disabled",!0),this.$playback_button.prop("disabled",!1),this.$reset_button.prop("disabled",!1);break;case"start_playback":this.$playback_button.text(this.$playback_button.attr("data-label-pause")),this.$playback_button.addClass("-is-playing");break;case"pause_playback":this.$playback_button.text(this.$playback_button.attr("data-label-play")),this.$playback_button.removeClass("-is-playing");break;case"reset":this.$record_button.text(this.$record_button.attr("data-label-record")),this.$record_button.removeClass("-is-recording"),this.$stop_record_button.prop("disabled",!0),this.$playback_button.prop("disabled",!0),this.$playback_button.text(this.$playback_button.attr("data-label-play")),this.$playback_button.removeClass("-is-playing"),this.$reset_button.prop("disabled",!0)}},Charcoal.Admin.Property_Audio.prototype.manage_recording=function(a){var b=this;if("stop"===a)return b.audio_recorder.stop(),b.audio_recorder.get_buffers(function(a){b.got_buffers(a),b.audio_recorder.clear()}),void b.manage_button_states("stop_recording");if(b.audio_recorder.is_recording())b.audio_recorder.stop(),b.manage_button_states("pause_recording");else{if(!b.audio_recorder)return;b.audio_recorder.record(),b.manage_button_states("start_recording")}},Charcoal.Admin.Property_Audio.prototype.toggle_playback=function(){if(this.audio_player.is_playing())this.audio_player.pause(),this.manage_button_states("pause_playback");else{if(!this.audio_player)return;this.audio_player.play(),this.manage_button_states("start_playback")}},Charcoal.Admin.Property_Audio.prototype.reset_audio=function(){var a=window.document.getElementById("analyser"),b=a.getContext("2d");b.clearRect(0,0,a.canvas_width,a.canvas_height);var c=window.document.getElementById("wavedisplay"),d=c.getContext("2d");d.clearRect(0,0,c.canvas_width,c.canvas_height),this.audio_player.load(),this.audio_player.src(""),this.audio_recorder.stop(),this.audio_recorder.clear(),this.manage_button_states("reset")},Charcoal.Admin.Property_Audio.prototype.got_buffers=function(a){var b=window.document.getElementById("wavedisplay"),c=this;c.draw_buffer(b.width,b.height,b.getContext("2d"),a[0]),c.audio_recorder.export_wav(function(a){c.done_encoding(a)})},Charcoal.Admin.Property_Audio.prototype.draw_buffer=function(a,b,c,d){var e=Math.ceil(d.length/a),f=b/2;c.fillStyle="silver",c.clearRect(0,0,a,b);for(var g=0;a>g;g++){for(var h=1,i=-1,j=0;e>j;j++){var k=d[g*e+j];h>k&&(h=k),k>i&&(i=k)}c.fillRect(g,(1+h)*f,1,Math.max(1,(i-h)*f))}},Charcoal.Admin.Property_Audio.prototype.done_encoding=function(a){var b=new window.FileReader,c=null,d=this;b.readAsDataURL(a),b.onloadend=function(){c=b.result,d.recording_index++,d.manage_audio_data(c)}},Charcoal.Admin.Property_Audio.prototype.manage_audio_data=function(a){if(a){var b=window.document.getElementById(this.input_id);b&&(b.value=a),this.audio_player.src(a),this.audio_player.load(),this.$playback_button.removeClass("-is-hidden")}},Charcoal.Admin.Property_Audio.prototype.cancel_analyser_update=function(){window.cancelAnimationFrame(this.animation_frame),this.animation_frame=null},Charcoal.Admin.Property_Audio.prototype.update_analysers=function(){var a=this;if(!a.analyserContext){var b=window.document.getElementById("analyser");a.canvas_width=b.width,a.canvas_height=b.height,a.analyserContext=b.getContext("2d")}var c=3,d=1,e=Math.round(a.canvas_width/c),f=new window.Uint8Array(window.analyserNode.frequencyBinCount),g=0;window.analyserNode.getByteFrequencyData(f),g=window.analyserNode.frequencyBinCount/e,a.analyserContext.clearRect(0,0,a.canvas_width,a.canvas_height),a.analyserContext.fillStyle="#F6D565",a.analyserContext.lineCap="round";for(var h=0;e>h;++h){for(var i=0,j=Math.floor(h*g),k=0;g>k;k++)i+=f[j+k];i/=g,a.analyserContext.fillStyle="hsl( "+Math.round(360*h/e)+", 100%, 50%)",a.analyserContext.fillRect(h*c,a.canvas_height,d,-i)}a.animation_frame=window.requestAnimationFrame(function(){a.update_analysers()})},function(a){var b="../../assets/admin/scripts/vendors/recorderWorker.js",c=function(c,d){var e,f=d||{},g=f.buffer_length||4096,h=new a.Worker(f.workerPath||b),i=!1;this.context=c.context,this.context.createScriptProcessor?this.node=this.context.createScriptProcessor(g,2,2):this.node=this.context.createJavaScriptNode(g,2,2),h.postMessage({command:"init",config:{sampleRate:this.context.sampleRate}}),this.node.onaudioprocess=function(a){i&&h.postMessage({command:"record",buffer:[a.inputBuffer.getChannelData(0),a.inputBuffer.getChannelData(1)]})},this.configure=function(a){for(var b in a)a.hasOwnProperty(b)&&(f[b]=a[b])},this.record=function(){i=!0},this.stop=function(){i=!1},this.clear=function(){h.postMessage({command:"clear"})},this.get_buffers=function(a){e=a||f.callback,h.postMessage({command:"getBuffers"})},this.export_wav=function(a,b){if(e=a||f.callback,b=b||f.type||"audio/wav",!e)throw new Error("Callback not set");h.postMessage({command:"exportWAV",type:b})},this.is_recording=function(){return i},h.onmessage=function(a){var b=a.data;e(b)},c.connect(this.node),this.node.connect(this.context.destination)};a.Recorder=c}(window),function(a){var b=function(b){this.callbacks={on_ended:b.on_ended||function(){},on_pause:b.on_pause||function(){},on_playing:b.on_playing||function(){},on_timeupdate:b.on_timeupdate||function(){}},this.element=new a.Audio,this.play=function(){this.element.play()},this.pause=function(){this.element.pause()},this.load=function(){this.element.load()},this.src=function(a){this.element.src=a},this.is_playing=function(){return!this.element.paused&&!this.element.ended&&this.element.currentTime>0};var c=this;c.element.addEventListener("ended",function(){c.callbacks.on_ended()}),c.element.addEventListener("pause",function(){c.callbacks.on_pause()}),c.element.addEventListener("playing",function(){c.callbacks.on_playing()}),c.element.addEventListener("timeupdate",function(){c.callbacks.on_timeupdate()})};a.Audio_Player=b}(window),Charcoal.Admin.Property_Input_Switch=function(a){this.input_type="charcoal/admin/property/input/switch",this.input_id=null,this.input_selector=null,this.switch_selector=null,this.set_properties(a).create_switch()},Charcoal.Admin.Property_Input_Switch.prototype=Object.create(Charcoal.Admin.Property.prototype),Charcoal.Admin.Property_Input_Switch.prototype.constructor=Charcoal.Admin.Property_Input_Switch,Charcoal.Admin.Property_Input_Switch.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_Switch.prototype.set_properties=function(a){return this.input_id=a.id||this.input_id,this.input_selector=a.data.input_selector||this.input_selector,this.switch_selector=a.data.switch_selector||this.switch_selector,this},Charcoal.Admin.Property_Input_Switch.prototype.create_switch=function(){var a=this;$(a.switch_selector).bootstrapSwitch({onSwitchChange:function(b,c){$(a.input_selector).val(c?1:0)}})},Charcoal.Admin.Property_Input_Tinymce=function(a){this.input_type="charcoal/admin/property/input/tinymce",this.input_id=null,this.editor_options=null,this.set_properties(a).create_tinymce()},Charcoal.Admin.Property_Input_Tinymce.prototype=Object.create(Charcoal.Admin.Property.prototype),Charcoal.Admin.Property_Input_Tinymce.prototype.constructor=Charcoal.Admin.Property_Input_Tinymce,Charcoal.Admin.Property_Input_Tinymce.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_Tinymce.prototype.set_properties=function(a){this.input_id=a.id||this.input_id,this.editor_options=a.editor_options||this.editor_options;var b={plugins:["advlist","anchor","autolink","autoresize","charmap","code","colorpicker","contextmenu","fullscreen","hr","image","link","lists","media","nonbreaking","noneditable","paste","print","searchreplace","tabfocus","table","visualblocks","visualchars","wordcount"],toolbar:"undo redo | styleselect | bold italic | forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image anchor",browser_spellcheck:!0,end_container_on_empty_block:!0,allow_conditional_comments:!0,convert_fonts_to_spans:!0,forced_root_block:"p",allow_script_urls:!1,document_base_url:"{{base_url}}",relative_urls:!0,remove_script_host:!1,autoresize_min_height:"150px",autoresize_max_height:"400px",contextmenu:"link image inserttable | cell row column deletetable",image_advtab:!0,importcss_append:!0,media_alt_source:!1,media_poster:!0,media_dimensions:!0,nonbreaking_force_tab:!1,paste_data_images:!0,paste_as_text:!0,paste_merge_formats:!0,table_grid:!0,table_tab_navigation:!0,visualblocks_default_state:!1};return this.editor_options=$.extend({},b,this.editor_options),this.editor_options.selector="#"+this.input_id,this},Charcoal.Admin.Property_Input_Tinymce.prototype.create_tinymce=function(){window.tinymce.init(this.editor_options)},Charcoal.Admin.Template=function(a){window.alert("Template "+a)},Charcoal.Admin.Template_Login=function(a){this.template_type="charcoal/admin/template/login",this.init(a)},Charcoal.Admin.Template_Login.prototype=Object.create(Charcoal.Admin.Template.prototype),Charcoal.Admin.Template_Login.prototype.constructor=Charcoal.Admin.Template_Login,Charcoal.Admin.Template_Login.prototype.parent=Charcoal.Admin.Template.prototype,Charcoal.Admin.Template_Login.prototype.init=function(a){window.console.debug(a),this.bind_events()},Charcoal.Admin.Template_Login.prototype.bind_events=function(){$(".js-login-submit").on("click",function(a){a.preventDefault();var b=$(this).parents("form"),c=Charcoal.Admin.admin_url()+"action/json/login",d=b.serialize();$.post(c,d,function(a){window.console.debug(a),a.success?window.location.href=a.next_url:BootstrapDialog.show({title:"Login error",message:"Authentication failed. Please try again.",type:BootstrapDialog.TYPE_DANGER})}).fail(function(){BootstrapDialog.show({title:"Login error",message:"Authentication failed. Please try again.",type:BootstrapDialog.TYPE_DANGER})})})},Charcoal.Admin.Template_MenuHeader=function(){$(".js-toggle-class").click(function(a){a.preventDefault();var b=$(this),c=b.data("class"),d=b.data("target");$(d).toggleClass(c)}),$(document).on("click",".js-accordion-header",function(a){a.preventDefault();var b=$(this);b.toggleClass("is-open").siblings(".js-accordion-content").stop().slideToggle()})},Charcoal.Admin.Widget=function(a){window.alert("Widget "+a)},Charcoal.Admin.Widget.prototype.reload=function(a){var b=this,c=Charcoal.Admin.admin_url()+"action/json/widget/load",d={widget_type:b.widget_type,widget_options:b.widget_options()};$.post(c,d,a)},Charcoal.Admin.Widget_Form=function(a){this.widget_type="charcoal/admin/widget/form",this.widget_id=null,this.obj_type=null,this.obj_id=null,this.form_selector=null,this.set_properties(a).bind_events()},Charcoal.Admin.Widget_Form.prototype=Object.create(Charcoal.Admin.Widget.prototype),Charcoal.Admin.Widget_Form.prototype.constructor=Charcoal.Admin.Widget_Form,Charcoal.Admin.Widget_Form.prototype.parent=Charcoal.Admin.Widget.prototype,Charcoal.Admin.Widget_Form.prototype.set_properties=function(a){return this.widget_id=a.id||this.widget_id,this.obj_type=a.data.obj_type||this.obj_type,this.obj_id=a.data.obj_id||this.obj_id,this.form_selector=a.data.form_selector||this.form_selector,this},Charcoal.Admin.Widget_Form.prototype.bind_events=function(){var a=this;$(a.form_selector).on("submit",function(b){b.preventDefault(),a.submit_form(this)})},Charcoal.Admin.Widget_Form.prototype.submit_form=function(a){var b,c,d=this,e=new FormData(a);d.obj_id?(b=Charcoal.Admin.admin_url()+"action/json/object/update",c=!1):(b=Charcoal.Admin.admin_url()+"action/json/object/save",c=!0),$.ajax({url:b,type:"POST",processData:!1,contentType:!1,data:e,success:function(a){console.debug(a),a.success?c?window.location.href=Charcoal.Admin.admin_url()+"object/edit?obj_type="+d.obj_type+"&obj_id="+a.obj_id:BootstrapDialog.show({title:"Save successful!",message:"Object was successfully saved to storage.",type:BootstrapDialog.TYPE_SUCCESS}):BootstrapDialog.show({title:"Error. Could not save object.",message:"An error occurred and the object could not be saved.",type:BootstrapDialog.TYPE_DANGER})},error:function(){BootstrapDialog.show({title:"Error. Could not save object.",message:"An error occurred and the object could not be saved.",type:BootstrapDialog.TYPE_DANGER})}})},Charcoal.Admin.Widget_Table=function(a){this.widget_type="charcoal/admin/widget/table",this.obj_type=null,this.widget_id=null,this.table_selector=null,this.properties=null,this.properties_options=null,this.filters=null,this.orders=null,this.pagination={page:1,num_per_page:50},this.set_properties(a).bind_events()},Charcoal.Admin.Widget_Table.prototype=Object.create(Charcoal.Admin.Widget.prototype),Charcoal.Admin.Widget_Table.prototype.constructor=Charcoal.Admin.Widget_Table,Charcoal.Admin.Widget_Table.prototype.parent=Charcoal.Admin.Widget.prototype,Charcoal.Admin.Widget_Table.prototype.set_properties=function(a){return this.obj_type=a.data.obj_type||this.obj_type,this.widget_id=a.id||this.widget_id,this.table_selector="#"+this.widget_id,this.properties=a.data.properties||this.properties,this.properties_options=a.data.properties_options||this.properties_options,this.filters=a.data.filters||this.filters,this.orders=a.data.orders||this.orders,this.pagination=a.data.pagination||this.pagination,this},Charcoal.Admin.Widget_Table.prototype.bind_events=function(){this.bind_obj_events(),this.bind_list_events(),this.bind_sublist_events()},Charcoal.Admin.Widget_Table.prototype.bind_obj_events=function(){var a=this;$(".js-obj-edit",this.table_selector).on("click",function(a){a.preventDefault();var b=$(this).parents("tr").data("id");window.alert("Edit "+b)}),$(".obj-quick-edit").on("click",function(b){b.preventDefault();var c=$(this).parents("tr").data("id"),d=Charcoal.Admin.admin_url()+"action/json/widget/load",e={widget_type:"charcoal/admin/widget/objectForm",widget_options:{obj_type:a.obj_type,obj_id:c}};$.post(d,e,function(a){var b=BootstrapDialog.show({title:"Quick Edit",message:"...",nl2br:!1});a.success?b.setMessage(a.widget_html):(b.setType(BootstrapDialog.TYPE_DANGER),b.setMessage("Error"))})}),$(".obj-inline-edit").on("click",function(b){b.preventDefault();var c=$(this).parents("tr"),d=c.data("id"),e=Charcoal.Admin.admin_url()+"action/json/widget/table/inline",f={obj_type:a.obj_type,obj_id:d};$.post(e,f,function(a){if(a.success){var b,d=a.inline_properties;for(b in d){var e=c.find(".property-"+b);e.html(d[b])}}})}),$(".obj-delete").on("click",function(b){b.preventDefault();var c=$(this).parents("tr").data("id");if(window.confirm("Are you sure you want to delete this object?")){var d=Charcoal.Admin.admin_url()+"action/json/object/delete",e={obj_type:a.obj_type,obj_id:c};$.post(d,e,function(b){b.success?a.reload():window.alert("Delete failed.")})}})},Charcoal.Admin.Widget_Table.prototype.bind_list_events=function(){var a=this;$(".list-quick-create").on("click",function(b){b.preventDefault();var c=Charcoal.Admin.admin_url()+"action/json/widget/load",d={widget_type:"charcoal/admin/widget/objectForm",widget_options:{obj_type:a.obj_type,obj_id:0}};$.post(c,d,function(a){var b=BootstrapDialog.show({title:"Quick Create",message:"...",nl2br:!1});a.success?b.setMessage(a.widget_html):(b.setType(BootstrapDialog.TYPE_DANGER),b.setMessage("Error"))})})},Charcoal.Admin.Widget_Table.prototype.bind_sublist_events=function(){var a=this;$(".sublist-inline-edit").on("click",function(b){b.preventDefault();var c=a.sublist(),d=Charcoal.Admin.admin_url()+"action/json/widget/table/inlinemulti",e={obj_type:a.obj_type,obj_ids:c.obj_ids};$.post(d,e,function(a){if(a.success)for(var b=a.objects,d=0;d<=b.length-1;d++){window.console.debug(b[d]);var e=b[d].inline_properties,f=$(c.elems[d]).parents("tr"),g=0;for(g in e){var h=f.find(".property-"+g);h.html(e[g])}}})})},Charcoal.Admin.Widget_Table.prototype.sublist=function(){var a=$(".select-row:checked"),b={elems:[],obj_ids:[]};return a.each(function(a,c){b.obj_ids.push($(c).parents("tr").data("id")),b.elems.push(c)}),b},Charcoal.Admin.Widget_Table.prototype.widget_options=function(){return{obj_type:this.obj_type,properties:this.properties,properties_options:this.properties_options,filters:this.filters,orders:this.orders,pagination:this.pagination}},Charcoal.Admin.Widget_Table.prototype.reload=function(){var a=this,b=Charcoal.Admin.admin_url()+"action/json/widget/load",c={widget_type:a.widget_type,widget_options:a.widget_options()};$.post(b,c,function(b){b.success&&b.widget_html&&($("#"+a.widget_id).replaceWith(b.widget_html),a.widget_id=b.widget_id,a.bind_events())})},Charcoal.Admin.Widget_Wysiwyg=function(){$(".js-wysiwyg").summernote({height:300})};