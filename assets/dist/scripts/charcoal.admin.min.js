/*! charcoal-admin 26-06-2015 */
var Charcoal=Charcoal||{};Charcoal.Admin=function(){return arguments.callee.singleton_instance?arguments.callee.singleton_instance:(arguments.callee.singleton_instance=this,this.url="",this.admin_path="",void(this.admin_url=function(){return this.url+this.admin_path+"/"}))},Charcoal.Admin.Property=function(a){window.alert("Property "+a)},Charcoal.Admin.Property.prototype.admin=new Charcoal.Admin,Charcoal.Admin.Property_Audio=function(a){this.property_type="charcoal/admin/property/audio",this.audioContext=new window.AudioContext||new window.webkitAudioContext,this.audioInput=null,this.realAudioInput=null,this.inputPoint=null,this.audioRecorder=null,this.rafID=null,this.analyserContext=null,this.canvasWidth=0,this.canvasHeight=0,this.recIndex=0,window.analyserNode=null,this.init(a)},Charcoal.Admin.Property_Audio.prototype=Object.create(Charcoal.Admin.Property.prototype),Charcoal.Admin.Property_Audio.prototype.constructor=Charcoal.Admin.Property_Audio,Charcoal.Admin.Property_Audio.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Audio.prototype.admin=new Charcoal.Admin,Charcoal.Admin.Property_Audio.prototype.init=function(a){var b=$.extend(!0,{},this.default_data(),a);this.set_data(b),this.bind_events(),this.initAudio()},Charcoal.Admin.Property_Audio.prototype.default_data=function(){return{obj_type:"",input_id:null}},Charcoal.Admin.Property_Audio.prototype.set_data=function(a){return this.obj_type=a.obj_type,this.input_id=a.input_id,this},Charcoal.Admin.Property_Audio.prototype.bind_events=function(){this.bind_obj_events()},Charcoal.Admin.Property_Audio.prototype.bind_obj_events=function(){var a=this;$(".btn-record").on("click",function(b){a.toggleRecording(b.target)})},Charcoal.Admin.Property_Audio.prototype.gotBuffers=function(a){var b=window.document.getElementById("wavedisplay"),c=this;c.drawBuffer(b.width,b.height,b.getContext("2d"),a[0]),c.audioRecorder.exportWAV(function(a){c.doneEncoding(a)})},Charcoal.Admin.Property_Audio.prototype.saveToInput=function(a){if(a){var b=window.document.getElementById(this.input_id);b&&(b.value=a)}},Charcoal.Admin.Property_Audio.prototype.drawBuffer=function(a,b,c,d){var e=Math.ceil(d.length/a),f=b/2;c.fillStyle="silver",c.clearRect(0,0,a,b);for(var g=0;a>g;g++){for(var h=1,i=-1,j=0;e>j;j++){var k=d[g*e+j];h>k&&(h=k),k>i&&(i=k)}c.fillRect(g,(1+h)*f,1,Math.max(1,(i-h)*f))}},Charcoal.Admin.Property_Audio.prototype.doneEncoding=function(a){var b=new window.FileReader,c=null,d=this;b.readAsDataURL(a),b.onloadend=function(){c=b.result,d.recIndex++,d.saveToInput(c)}},Charcoal.Admin.Property_Audio.prototype.toggleRecording=function(a){var b=this;if(a.classList.contains("-is-recording"))b.audioRecorder.stop(),a.classList.remove("-is-recording"),b.audioRecorder.getBuffers(function(a){b.gotBuffers(a)});else{if(!b.audioRecorder)return;a.classList.add("-is-recording"),b.audioRecorder.clear(),b.audioRecorder.record()}},Charcoal.Admin.Property_Audio.prototype.cancelAnalyserUpdates=function(){window.cancelAnimationFrame(this.rafID),this.rafID=null},Charcoal.Admin.Property_Audio.prototype.updateAnalysers=function(){var a=this;if(!a.analyserContext){var b=window.document.getElementById("analyser");a.canvasWidth=b.width,a.canvasHeight=b.height,a.analyserContext=b.getContext("2d")}var c=3,d=1,e=Math.round(a.canvasWidth/c),f=new window.Uint8Array(window.analyserNode.frequencyBinCount);window.analyserNode.getByteFrequencyData(f),a.analyserContext.clearRect(0,0,a.canvasWidth,a.canvasHeight),a.analyserContext.fillStyle="#F6D565",a.analyserContext.lineCap="round";for(var g=window.analyserNode.frequencyBinCount/e,h=0;e>h;++h){for(var i=0,j=Math.floor(h*g),k=0;g>k;k++)i+=f[j+k];i/=g,a.analyserContext.fillStyle="hsl( "+Math.round(360*h/e)+", 100%, 50%)",a.analyserContext.fillRect(h*c,a.canvasHeight,d,-i)}a.rafID=window.requestAnimationFrame(function(){a.updateAnalysers()})},Charcoal.Admin.Property_Audio.prototype.gotStream=function(a){this.inputPoint=this.audioContext.createGain(),this.realAudioInput=this.audioContext.createMediaStreamSource(a),this.audioInput=this.realAudioInput,this.audioInput.connect(this.inputPoint),window.analyserNode=this.audioContext.createAnalyser(),window.analyserNode.fftSize=2048,this.inputPoint.connect(window.analyserNode),this.audioRecorder=new window.Recorder(this.inputPoint);var b=this.audioContext.createGain();b.gain.value=0,this.inputPoint.connect(b),b.connect(this.audioContext.destination),this.updateAnalysers()},Charcoal.Admin.Property_Audio.prototype.initAudio=function(){var a=this;window.navigator.getUserMedia||(window.navigator.getUserMedia=window.navigator.webkitGetUserMedia||window.navigator.mozGetUserMedia),window.navigator.cancelAnimationFrame||(window.navigator.cancelAnimationFrame=window.navigator.webkitCancelAnimationFrame||window.navigator.mozCancelAnimationFrame),window.navigator.requestAnimationFrame||(window.navigator.requestAnimationFrame=window.navigator.webkitRequestAnimationFrame||window.navigator.mozRequestAnimationFrame),window.navigator.getUserMedia({audio:{mandatory:{googEchoCancellation:!1,googAutoGainControl:!1,googNoiseSuppression:!1,googHighpassFilter:!1},optional:[]}},function(b){a.gotStream(b)},function(a){window.alert("Error getting audio. Try plugging in a microphone"),window.console.log(a)})},function(a){var b="../../assets/admin/scripts/vendors/recorderWorker.js",c=function(c,d){var e=d||{},f=e.bufferLen||4096;this.context=c.context,this.context.createScriptProcessor?this.node=this.context.createScriptProcessor(f,2,2):this.node=this.context.createJavaScriptNode(f,2,2);var g=new a.Worker(e.workerPath||b);g.postMessage({command:"init",config:{sampleRate:this.context.sampleRate}});var h,i=!1;this.node.onaudioprocess=function(a){i&&g.postMessage({command:"record",buffer:[a.inputBuffer.getChannelData(0),a.inputBuffer.getChannelData(1)]})},this.configure=function(a){for(var b in a)a.hasOwnProperty(b)&&(e[b]=a[b])},this.record=function(){i=!0},this.stop=function(){i=!1},this.clear=function(){g.postMessage({command:"clear"})},this.getBuffers=function(a){h=a||e.callback,g.postMessage({command:"getBuffers"})},this.exportWAV=function(a,b){if(h=a||e.callback,b=b||e.type||"audio/wav",!h)throw new Error("Callback not set");g.postMessage({command:"exportWAV",type:b})},this.exportMonoWAV=function(a,b){if(h=a||e.callback,b=b||e.type||"audio/wav",!h)throw new Error("Callback not set");g.postMessage({command:"exportMonoWAV",type:b})},g.onmessage=function(a){var b=a.data;h(b)},c.connect(this.node),this.node.connect(this.context.destination)};a.Recorder=c}(window),Charcoal.Admin.Template=function(a){window.alert("Template "+a)},Charcoal.Admin.Template.prototype.admin=new Charcoal.Admin,Charcoal.Admin.Template_Login=function(a){this.template_type="charcoal/admin/template/login",this.init(a)},Charcoal.Admin.Template_Login.prototype=Object.create(Charcoal.Admin.Template.prototype),Charcoal.Admin.Template_Login.prototype.constructor=Charcoal.Admin.Template_Login,Charcoal.Admin.Template_Login.prototype.parent=Charcoal.Admin.Template.prototype,Charcoal.Admin.Template_Login.prototype.admin=new Charcoal.Admin,Charcoal.Admin.Template_Login.prototype.init=function(a){window.console.debug(a),this.bind_events()},Charcoal.Admin.Template_Login.prototype.bind_events=function(){var a=this;$(".login-submit").on("click",function(b){b.preventDefault();var c=$(this).parents("form"),d=a.admin.admin_url()+"action/json/login",e=c.serialize();$.post(d,e,function(a){window.console.debug(a),a.success?window.location.href=a.next_url:window.alert("Error")}).fail(function(){window.alert("Error")})})},Charcoal.Admin.Template_MenuHeader=function(){$('[data-toggle="class"]').click(function(a){a.preventDefault();var b=$(this),c=b.data("class"),d=b.data("target");$(d).toggleClass(c)})},Charcoal.Admin.Widget=function(a){window.alert("Widget "+a)},Charcoal.Admin.Widget.prototype.admin=new Charcoal.Admin,Charcoal.Admin.Widget.prototype.reload=function(a){var b=this,c=b.admin.admin_url()+"action/json/widget/load",d={widget_type:b.widget_type,widget_options:b.widget_options()};$.post(c,d,a)},Charcoal.Admin.Widget_Form=function(a){this.widget_type="charcoal/admin/widget/form",this.obj_type=null,this.obj_id=null,this.init(a)},Charcoal.Admin.Widget_Form.prototype=Object.create(Charcoal.Admin.Widget.prototype),Charcoal.Admin.Widget_Form.prototype.constructor=Charcoal.Admin.Widget_Form,Charcoal.Admin.Widget_Form.prototype.parent=Charcoal.Admin.Widget.prototype,Charcoal.Admin.Widget_Form.prototype.admin=new Charcoal.Admin,Charcoal.Admin.Widget_Form.prototype.init=function(a){var b=$.extend(!0,{},this.default_data(),a);this.set_data(b),this.bind_events()},Charcoal.Admin.Widget_Form.prototype.default_data=function(){return{obj_type:"",widget_id:null,properties:null,properties_options:null,filters:null,orders:null,pagination:{page:1,num_per_page:50}}},Charcoal.Admin.Widget_Form.prototype.set_data=function(a){return window.console.debug(a),this},Charcoal.Admin.Widget_Form.prototype.bind_events=function(){var a=this;$(".form-submit").on("click",function(b){b.preventDefault();var c;c=a.obj_id?a.admin.admin_url()+"action/json/object/update":a.admin.admin_url()+"action/json/object/save";var d=$(this).parents("form"),e={obj_type:a.obj_type,obj_id:a.obj_id,obj_data:d.serialize()};$.post(c,e,function(a){window.console.debug(a),a.success?window.alert("Save successful!"):window.alert("Error. Could not save object.")}).fail(function(){window.alert("Error attempting to save form.")})})},Charcoal.Admin.Widget_Table=function(a){this.widget_type="charcoal/admin/widget/table",this.obj_type=null,this.widget_id=null,this.properties=null,this.properties_options=null,this.filters=null,this.orders=null,this.pagination=null,this.filters=null,this.init(a)},Charcoal.Admin.Widget_Table.prototype=Object.create(Charcoal.Admin.Widget.prototype),Charcoal.Admin.Widget_Table.prototype.constructor=Charcoal.Admin.Widget_Table,Charcoal.Admin.Widget_Table.prototype.parent=Charcoal.Admin.Widget.prototype,Charcoal.Admin.Widget_Table.prototype.admin=new Charcoal.Admin,Charcoal.Admin.Widget_Table.prototype.init=function(a){var b=$.extend(!0,{},this.default_data(),a);this.set_data(b),this.bind_events()},Charcoal.Admin.Widget_Table.prototype.default_data=function(){return{obj_type:"",widget_id:null,properties:null,properties_options:null,filters:null,orders:null,pagination:{page:1,num_per_page:50}}},Charcoal.Admin.Widget_Table.prototype.set_data=function(a){return this.obj_type=a.obj_type||"",this.widget_id=a.widget_id||null,this},Charcoal.Admin.Widget_Table.prototype.bind_events=function(){this.bind_obj_events(),this.bind_list_events(),this.bind_sublist_events()},Charcoal.Admin.Widget_Table.prototype.bind_obj_events=function(){var a=this;$(".obj-edit").on("click",function(a){a.preventDefault();var b=$(this).parents("tr").data("id");window.alert("Edit "+b)}),$(".obj-quick-edit").on("click",function(b){b.preventDefault();var c=$(this).parents("tr").data("id"),d=a.admin.admin_url()+"action/json/widget/load",e={widget_type:"charcoal/admin/widget/objectForm",widget_options:{obj_type:a.obj_type,obj_id:c}};$.post(d,e,function(a){var b=BootstrapDialog.show({title:"Quick Edit",message:"...",nl2br:!1});a.success?b.setMessage(a.widget_html):(b.setType(BootstrapDialog.TYPE_DANGER),b.setMessage("Error"))})}),$(".obj-inline-edit").on("click",function(b){b.preventDefault();var c=$(this).parents("tr"),d=c.data("id"),e=a.admin.admin_url()+"action/json/widget/table/inline",f={obj_type:a.obj_type,obj_id:d};$.post(e,f,function(a){if(a.success){var b,d=a.inline_properties;for(b in d){var e=c.find(".property-"+b);e.html(d[b])}}})}),$(".obj-delete").on("click",function(b){b.preventDefault();var c=$(this).parents("tr").data("id");if(window.confirm("Are you sure you want to delete this object?")){var d=a.admin.admin_url()+"action/json/object/delete",e={obj_type:a.obj_type,obj_id:c};$.post(d,e,function(b){b.success?a.reload():window.alert("Delete failed.")})}})},Charcoal.Admin.Widget_Table.prototype.bind_list_events=function(){var a=this;$(".list-quick-create").on("click",function(b){b.preventDefault();var c=a.admin.admin_url()+"action/json/widget/load",d={widget_type:"charcoal/admin/widget/objectForm",widget_options:{obj_type:a.obj_type,obj_id:0}};$.post(c,d,function(a){var b=BootstrapDialog.show({title:"Quick Create",message:"...",nl2br:!1});a.success?b.setMessage(a.widget_html):(b.setType(BootstrapDialog.TYPE_DANGER),b.setMessage("Error"))})})},Charcoal.Admin.Widget_Table.prototype.bind_sublist_events=function(){var a=this;$(".sublist-inline-edit").on("click",function(b){b.preventDefault();var c=a.sublist(),d=a.admin.admin_url()+"action/json/widget/table/inlinemulti",e={obj_type:a.obj_type,obj_ids:c.obj_ids};$.post(d,e,function(a){if(a.success)for(var b=a.objects,d=0;d<=b.length-1;d++){window.console.debug(b[d]);var e=b[d].inline_properties,f=$(c.elems[d]).parents("tr"),g=0;for(g in e){var h=f.find(".property-"+g);h.html(e[g])}}})})},Charcoal.Admin.Widget_Table.prototype.sublist=function(){var a=$(".select-row:checked"),b={elems:[],obj_ids:[]};return a.each(function(a,c){b.obj_ids.push($(c).parents("tr").data("id")),b.elems.push(c)}),b},Charcoal.Admin.Widget_Table.prototype.widget_options=function(){return{obj_type:this.obj_type,properties:this.properties,properties_options:this.properties_options,filters:this.filters,orders:this.orders,pagination:this.pagination}},Charcoal.Admin.Widget_Table.prototype.reload=function(){var a=this,b=a.admin.admin_url()+"action/json/widget/load",c={widget_type:a.widget_type,widget_options:a.widget_options()};$.post(b,c,function(b){b.success&&b.widget_html&&($("#"+a.widget_id).replaceWith(b.widget_html),a.widget_id=b.widget_id,a.bind_events())})};