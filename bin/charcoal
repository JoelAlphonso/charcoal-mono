#!/usr/bin/env php
<?php

use \Charcoal\App\App;
use \Charcoal\App\AppConfig;
use \Charcoal\App\AppContainer;

use \Slim\Http\Environment as SlimEnvironment;

$autoloaderPath = [
    __DIR__. '/../../../../vendor/autoload.php',
    __DIR__. '/../vendor/autoload.php'
];

foreach ($autoloaderPath as $file) {
    if (file_exists($file)) {
        include $file;
        break;
    }
}
$baseDir = realpath(dirname(dirname($file)));

// Ensure CLI mode
if (PHP_SAPI !== 'cli') {
    die('This program can only be executed from a terminal / Command Line Interface'."\n");
}

global $argv;
// Convert command line arguments into a URL (for Slim)
$argv = $GLOBALS['argv'];
if (!isset($argv[1])) {
    die('This script requires at least one parameter: the script action name / ident.'."\n");
}
$path = '/'.ltrim($argv[1], '/');


$config = new AppConfig();
$config->addFile($baseDir.'/config/config.php');
$config->set('ROOT', $baseDir . '/');

// Create container and configure it (with charcoal-config)
$container = new AppContainer([
    'settings'  => [],
    'config'    => $config
]);

// Handle "404 Not Found"
$container['notFoundHandler'] = function ($c)
{
    return function ($request, $response) use ($c)
    {
        return $c['response']
            ->withStatus(404)
            ->write('Script not found'."\n");
    };
};

// Handle "500 Server Error"
$container['errorHandler'] = function ($c)
{
    return function ($request, $response, $exception) use ($c)
    {
        return $c['response']
            ->withStatus(500)
            ->write(
                sprintf('Something went wrong! (%s)'."\n", $exception->getMessage())
            );
    };
};

// Fake environment (for CLI) with path
$container['environment'] = function($c) use ($path) {
    return SlimEnvironment::mock([
        'PATH_INFO' => $path,
        'REQUEST_URI' => $path
    ]);
};

// Charcoal / Slim is the main app
$app = App::instance($container);

// Set up dependencies
require $baseDir.'/config/dependencies.php';
// Register middlewares
require $baseDir.'/config/middlewares.php';

$app->run();
